define(["exports","./when-7ef6387a","./Check-ed6a1804","./Cartesian3-cb3509e0","./Ellipsoid-fc93f17d","./Transforms-fe3a4031","./Matrix4-a5b26d08"],(function(a,t,e,r,n,i,s){"use strict";var o={};function u(a,t,e){var n=a+t;return r.CesiumMath.sign(a)!==r.CesiumMath.sign(t)&&Math.abs(n/Math.max(Math.abs(a),Math.abs(t)))<e?0:n}o.computeDiscriminant=function(a,t,e){return t*t-4*a*e},o.computeRealRoots=function(a,t,e){var n;if(0===a)return 0===t?[]:[-e/t];if(0===t){if(0===e)return[0,0];var i=Math.abs(e),s=Math.abs(a);if(i<s&&i/s<r.CesiumMath.EPSILON14)return[0,0];if(i>s&&s/i<r.CesiumMath.EPSILON14)return[];if((n=-e/a)<0)return[];var o=Math.sqrt(n);return[-o,o]}if(0===e)return(n=-t/a)<0?[n,0]:[0,n];var C=u(t*t,-(4*a*e),r.CesiumMath.EPSILON14);if(C<0)return[];var c=-.5*u(t,r.CesiumMath.sign(t)*Math.sqrt(C),r.CesiumMath.EPSILON14);return t>0?[c/a,e/c]:[e/c,c/a]};var C={};function c(a,t,e,r){var n,i,s=a,o=t/3,u=e/3,C=r,c=s*u,l=o*C,h=o*o,M=u*u,f=s*u-h,m=s*C-o*u,d=o*C-M,v=4*f*d-m*m;if(v<0){var g,p,w;h*l>=c*M?(g=s,p=f,w=-2*o*f+s*m):(g=C,p=d,w=-C*m+2*u*d);var R=-(w<0?-1:1)*Math.abs(g)*Math.sqrt(-v),S=(i=-w+R)/2,O=S<0?-Math.pow(-S,1/3):Math.pow(S,1/3),x=i===R?-O:-p/O;return n=p<=0?O+x:-w/(O*O+x*x+p),h*l>=c*M?[(n-o)/s]:[-C/(n+u)]}var y=f,P=-2*o*f+s*m,b=d,N=-C*m+2*u*d,q=Math.sqrt(v),L=Math.sqrt(3)/2,I=Math.abs(Math.atan2(s*q,-P)/3);n=2*Math.sqrt(-y);var E=Math.cos(I);i=n*E;var z=n*(-E/2-L*Math.sin(I)),T=i+z>2*o?i-o:z-o,U=s,W=T/U;I=Math.abs(Math.atan2(C*q,-N)/3);var B=-C,V=(i=(n=2*Math.sqrt(-b))*(E=Math.cos(I)))+(z=n*(-E/2-L*Math.sin(I)))<2*u?i+u:z+u,Z=B/V,A=-T*V-U*B,D=(u*A-o*(T*B))/(-o*A+u*(U*V));return W<=D?W<=Z?D<=Z?[W,D,Z]:[W,Z,D]:[Z,W,D]:W<=Z?[D,W,Z]:D<=Z?[D,Z,W]:[Z,D,W]}C.computeDiscriminant=function(a,t,e,r){var n=t*t,i=e*e;return 18*a*t*e*r+n*i-27*(a*a)*(r*r)-4*(a*i*e+n*t*r)},C.computeRealRoots=function(a,t,e,r){var n,i;if(0===a)return o.computeRealRoots(t,e,r);if(0===t){if(0===e){if(0===r)return[0,0,0];var s=(i=-r/a)<0?-Math.pow(-i,1/3):Math.pow(i,1/3);return[s,s,s]}return 0===r?0===(n=o.computeRealRoots(a,0,e)).Length?[0]:[n[0],0,n[1]]:c(a,0,e,r)}return 0===e?0===r?(i=-t/a)<0?[i,0,0]:[0,0,i]:c(a,t,0,r):0===r?0===(n=o.computeRealRoots(a,t,e)).length?[0]:n[1]<=0?[n[0],n[1],0]:n[0]>=0?[0,n[0],n[1]]:[n[0],0,n[1]]:c(a,t,e,r)};var l={};function h(a,t,e,n){var i=a*a,s=t-3*i/8,u=e-t*a/2+i*a/8,c=n-e*a/4+t*i/16-3*i*i/256,l=C.computeRealRoots(1,2*s,s*s-4*c,-u*u);if(l.length>0){var h=-a/4,M=l[l.length-1];if(Math.abs(M)<r.CesiumMath.EPSILON14){var f=o.computeRealRoots(1,s,c);if(2===f.length){var m,d=f[0],v=f[1];if(d>=0&&v>=0){var g=Math.sqrt(d),p=Math.sqrt(v);return[h-p,h-g,h+g,h+p]}if(d>=0&&v<0)return[h-(m=Math.sqrt(d)),h+m];if(d<0&&v>=0)return[h-(m=Math.sqrt(v)),h+m]}return[]}if(M>0){var w=Math.sqrt(M),R=(s+M-u/w)/2,S=(s+M+u/w)/2,O=o.computeRealRoots(1,w,R),x=o.computeRealRoots(1,-w,S);return 0!==O.length?(O[0]+=h,O[1]+=h,0!==x.length?(x[0]+=h,x[1]+=h,O[1]<=x[0]?[O[0],O[1],x[0],x[1]]:x[1]<=O[0]?[x[0],x[1],O[0],O[1]]:O[0]>=x[0]&&O[1]<=x[1]?[x[0],O[0],O[1],x[1]]:x[0]>=O[0]&&x[1]<=O[1]?[O[0],x[0],x[1],O[1]]:O[0]>x[0]&&O[0]<x[1]?[x[0],O[0],x[1],O[1]]:[O[0],x[0],O[1],x[1]]):O):0!==x.length?(x[0]+=h,x[1]+=h,x):[]}}return[]}function M(a,t,e,n){var i=a*a,s=-2*t,u=e*a+t*t-4*n,c=i*n-e*t*a+e*e,l=C.computeRealRoots(1,s,u,c);if(l.length>0){var h,M,f,m,d,v,g=l[0],p=t-g,w=p*p,R=a/2,S=p/2,O=w-4*n,x=w+4*Math.abs(n),y=i-4*g,P=i+4*Math.abs(g);if(g<0||O*P<y*x){var b=Math.sqrt(y);h=b/2,M=0===b?0:(a*S-e)/b}else{var N=Math.sqrt(O);h=0===N?0:(a*S-e)/N,M=N/2}0===R&&0===h?(f=0,m=0):r.CesiumMath.sign(R)===r.CesiumMath.sign(h)?m=g/(f=R+h):f=g/(m=R-h),0===S&&0===M?(d=0,v=0):r.CesiumMath.sign(S)===r.CesiumMath.sign(M)?v=n/(d=S+M):d=n/(v=S-M);var q=o.computeRealRoots(1,f,d),L=o.computeRealRoots(1,m,v);if(0!==q.length)return 0!==L.length?q[1]<=L[0]?[q[0],q[1],L[0],L[1]]:L[1]<=q[0]?[L[0],L[1],q[0],q[1]]:q[0]>=L[0]&&q[1]<=L[1]?[L[0],q[0],q[1],L[1]]:L[0]>=q[0]&&L[1]<=q[1]?[q[0],L[0],L[1],q[1]]:q[0]>L[0]&&q[0]<L[1]?[L[0],q[0],L[1],q[1]]:[q[0],L[0],q[1],L[1]]:q;if(0!==L.length)return L}return[]}function f(a,e){e=r.Cartesian3.clone(t.defaultValue(e,r.Cartesian3.ZERO)),r.Cartesian3.equals(e,r.Cartesian3.ZERO)||r.Cartesian3.normalize(e,e),this.origin=r.Cartesian3.clone(t.defaultValue(a,r.Cartesian3.ZERO)),this.direction=e}l.computeDiscriminant=function(a,t,e,r,n){var i=a*a,s=t*t,o=s*t,u=e*e,C=u*e,c=r*r,l=c*r,h=n*n;return s*u*c-4*o*l-4*a*C*c+18*a*t*e*l-27*i*c*c+256*(i*a)*(h*n)+n*(18*o*e*r-4*s*C+16*a*u*u-80*a*t*u*r-6*a*s*c+144*i*e*c)+h*(144*a*s*e-27*s*s-128*i*u-192*i*t*r)},l.computeRealRoots=function(a,t,e,n,i){if(Math.abs(a)<r.CesiumMath.EPSILON15)return C.computeRealRoots(t,e,n,i);var s=t/a,o=e/a,u=n/a,c=i/a,l=s<0?1:0;switch(l+=o<0?l+1:l,l+=u<0?l+1:l,l+=c<0?l+1:l){case 0:return h(s,o,u,c);case 1:case 2:return M(s,o,u,c);case 3:case 4:return h(s,o,u,c);case 5:return M(s,o,u,c);case 6:case 7:return h(s,o,u,c);case 8:return M(s,o,u,c);case 9:case 10:return h(s,o,u,c);case 11:return M(s,o,u,c);case 12:case 13:case 14:case 15:return h(s,o,u,c);default:return}},f.clone=function(a,e){if(t.defined(a))return t.defined(e)?(e.origin=r.Cartesian3.clone(a.origin),e.direction=r.Cartesian3.clone(a.direction),e):new f(a.origin,a.direction)},f.getPoint=function(a,e,n){return t.defined(n)||(n=new r.Cartesian3),n=r.Cartesian3.multiplyByScalar(a.direction,e,n),r.Cartesian3.add(a.origin,n,n)};var m={rayPlane:function(a,e,n){t.defined(n)||(n=new r.Cartesian3);var i=a.origin,s=a.direction,o=e.normal,u=r.Cartesian3.dot(o,s);if(!(Math.abs(u)<r.CesiumMath.EPSILON15)){var C=(-e.distance-r.Cartesian3.dot(o,i))/u;if(!(C<0))return n=r.Cartesian3.multiplyByScalar(s,C,n),r.Cartesian3.add(i,n,n)}}},d=new r.Cartesian3,v=new r.Cartesian3,g=new r.Cartesian3,p=new r.Cartesian3,w=new r.Cartesian3;m.rayTriangleParametric=function(a,e,n,i,s){s=t.defaultValue(s,!1);var o,u,C,c,l,h=a.origin,M=a.direction,f=r.Cartesian3.subtract(n,e,d),m=r.Cartesian3.subtract(i,e,v),R=r.Cartesian3.cross(M,m,g),S=r.Cartesian3.dot(f,R);if(s){if(S<r.CesiumMath.EPSILON6)return;if(o=r.Cartesian3.subtract(h,e,p),(C=r.Cartesian3.dot(o,R))<0||C>S)return;if(u=r.Cartesian3.cross(o,f,w),(c=r.Cartesian3.dot(M,u))<0||C+c>S)return;l=r.Cartesian3.dot(m,u)/S}else{if(Math.abs(S)<r.CesiumMath.EPSILON6)return;var O=1/S;if(o=r.Cartesian3.subtract(h,e,p),(C=r.Cartesian3.dot(o,R)*O)<0||C>1)return;if(u=r.Cartesian3.cross(o,f,w),(c=r.Cartesian3.dot(M,u)*O)<0||C+c>1)return;l=r.Cartesian3.dot(m,u)*O}return l},m.rayTriangle=function(a,e,n,i,s,o){var u=m.rayTriangleParametric(a,e,n,i,s);if(t.defined(u)&&!(u<0))return t.defined(o)||(o=new r.Cartesian3),r.Cartesian3.multiplyByScalar(a.direction,u,o),r.Cartesian3.add(a.origin,o,o)};var R=new f;m.lineSegmentTriangle=function(a,e,n,i,s,o,u){var C=R;r.Cartesian3.clone(a,C.origin),r.Cartesian3.subtract(e,a,C.direction),r.Cartesian3.normalize(C.direction,C.direction);var c=m.rayTriangleParametric(C,n,i,s,o);if(!(!t.defined(c)||c<0||c>r.Cartesian3.distance(a,e)))return t.defined(u)||(u=new r.Cartesian3),r.Cartesian3.multiplyByScalar(C.direction,c,u),r.Cartesian3.add(C.origin,u,u)};var S={root0:0,root1:0};function O(a,e,n){t.defined(n)||(n=new i.Interval);var s=a.origin,o=a.direction,u=e.center,C=e.radius*e.radius,c=r.Cartesian3.subtract(s,u,g),l=function(a,t,e,r){var n=t*t-4*a*e;if(!(n<0)){if(n>0){var i=1/(2*a),s=Math.sqrt(n),o=(-t+s)*i,u=(-t-s)*i;return o<u?(r.root0=o,r.root1=u):(r.root0=u,r.root1=o),r}var C=-t/(2*a);if(0!==C)return r.root0=r.root1=C,r}}(r.Cartesian3.dot(o,o),2*r.Cartesian3.dot(o,c),r.Cartesian3.magnitudeSquared(c)-C,S);if(t.defined(l))return n.start=l.root0,n.stop=l.root1,n}m.raySphere=function(a,e,r){if(r=O(a,e,r),t.defined(r)&&!(r.stop<0))return r.start=Math.max(r.start,0),r};var x=new f;m.lineSegmentSphere=function(a,e,n,i){var s=x;r.Cartesian3.clone(a,s.origin);var o=r.Cartesian3.subtract(e,a,s.direction),u=r.Cartesian3.magnitude(o);if(r.Cartesian3.normalize(o,o),i=O(s,n,i),!(!t.defined(i)||i.stop<0||i.start>u))return i.start=Math.max(i.start,0),i.stop=Math.min(i.stop,u),i};var y=new r.Cartesian3,P=new r.Cartesian3;function b(a,t,e){var n=a+t;return r.CesiumMath.sign(a)!==r.CesiumMath.sign(t)&&Math.abs(n/Math.max(Math.abs(a),Math.abs(t)))<e?0:n}m.rayEllipsoid=function(a,t){var e,n,s,o,u,C=t.oneOverRadii,c=r.Cartesian3.multiplyComponents(C,a.origin,y),l=r.Cartesian3.multiplyComponents(C,a.direction,P),h=r.Cartesian3.magnitudeSquared(c),M=r.Cartesian3.dot(c,l);if(h>1){if(M>=0)return;var f=M*M;if(e=h-1,f<(s=(n=r.Cartesian3.magnitudeSquared(l))*e))return;if(f>s){o=M*M-s;var m=(u=-M+Math.sqrt(o))/n,d=e/u;return m<d?new i.Interval(m,d):{start:d,stop:m}}var v=Math.sqrt(e/n);return new i.Interval(v,v)}return h<1?(e=h-1,o=M*M-(s=(n=r.Cartesian3.magnitudeSquared(l))*e),u=-M+Math.sqrt(o),new i.Interval(0,u/n)):M<0?(n=r.Cartesian3.magnitudeSquared(l),new i.Interval(0,-M/n)):void 0};var N=new r.Cartesian3,q=new r.Cartesian3,L=new r.Cartesian3,I=new r.Cartesian3,E=new r.Cartesian3,z=new s.Matrix3,T=new s.Matrix3,U=new s.Matrix3,W=new s.Matrix3,B=new s.Matrix3,V=new s.Matrix3,Z=new s.Matrix3,A=new r.Cartesian3,D=new r.Cartesian3,k=new n.Cartographic;m.grazingAltitudeLocation=function(a,e){var n=a.origin,i=a.direction;if(!r.Cartesian3.equals(n,r.Cartesian3.ZERO)){var u=e.geodeticSurfaceNormal(n,N);if(r.Cartesian3.dot(i,u)>=0)return n}var C=t.defined(this.rayEllipsoid(a,e)),c=e.transformPositionToScaledSpace(i,N),h=r.Cartesian3.normalize(c,c),M=r.Cartesian3.mostOrthogonalAxis(c,I),f=r.Cartesian3.normalize(r.Cartesian3.cross(M,h,q),q),m=r.Cartesian3.normalize(r.Cartesian3.cross(h,f,L),L),d=z;d[0]=h.x,d[1]=h.y,d[2]=h.z,d[3]=f.x,d[4]=f.y,d[5]=f.z,d[6]=m.x,d[7]=m.y,d[8]=m.z;var v=s.Matrix3.transpose(d,T),g=s.Matrix3.fromScale(e.radii,U),p=s.Matrix3.fromScale(e.oneOverRadii,W),w=B;w[0]=0,w[1]=-i.z,w[2]=i.y,w[3]=i.z,w[4]=0,w[5]=-i.x,w[6]=-i.y,w[7]=i.x,w[8]=0;var R,S,O=s.Matrix3.multiply(s.Matrix3.multiply(v,p,V),w,V),x=s.Matrix3.multiply(s.Matrix3.multiply(O,g,Z),d,Z),y=s.Matrix3.multiplyByVector(O,n,E),P=function(a,t,e,n,i){var u,C=n*n,c=i*i,h=(a[s.Matrix3.COLUMN1ROW1]-a[s.Matrix3.COLUMN2ROW2])*c,M=i*(n*b(a[s.Matrix3.COLUMN1ROW0],a[s.Matrix3.COLUMN0ROW1],r.CesiumMath.EPSILON15)+t.y),f=a[s.Matrix3.COLUMN0ROW0]*C+a[s.Matrix3.COLUMN2ROW2]*c+n*t.x+e,m=c*b(a[s.Matrix3.COLUMN2ROW1],a[s.Matrix3.COLUMN1ROW2],r.CesiumMath.EPSILON15),d=i*(n*b(a[s.Matrix3.COLUMN2ROW0],a[s.Matrix3.COLUMN0ROW2])+t.z),v=[];if(0===d&&0===m){if(0===(u=o.computeRealRoots(h,M,f)).length)return v;var g=u[0],p=Math.sqrt(Math.max(1-g*g,0));if(v.push(new r.Cartesian3(n,i*g,i*-p)),v.push(new r.Cartesian3(n,i*g,i*p)),2===u.length){var w=u[1],R=Math.sqrt(Math.max(1-w*w,0));v.push(new r.Cartesian3(n,i*w,i*-R)),v.push(new r.Cartesian3(n,i*w,i*R))}return v}var S=d*d,O=m*m,x=d*m,y=h*h+O,P=2*(M*h+x),N=2*f*h+M*M-O+S,q=2*(f*M-x),L=f*f-S;if(0===y&&0===P&&0===N&&0===q)return v;var I=(u=l.computeRealRoots(y,P,N,q,L)).length;if(0===I)return v;for(var E=0;E<I;++E){var z=u[E],T=z*z,U=Math.max(1-T,0),W=Math.sqrt(U),B=(r.CesiumMath.sign(h)===r.CesiumMath.sign(f)?b(h*T+f,M*z,r.CesiumMath.EPSILON12):r.CesiumMath.sign(f)===r.CesiumMath.sign(M*z)?b(h*T,M*z+f,r.CesiumMath.EPSILON12):b(h*T+M*z,f,r.CesiumMath.EPSILON12))*b(m*z,d,r.CesiumMath.EPSILON15);B<0?v.push(new r.Cartesian3(n,i*z,i*W)):B>0?v.push(new r.Cartesian3(n,i*z,i*-W)):0!==W?(v.push(new r.Cartesian3(n,i*z,i*-W)),v.push(new r.Cartesian3(n,i*z,i*W)),++E):v.push(new r.Cartesian3(n,i*z,i*W))}return v}(x,r.Cartesian3.negate(y,N),0,0,1),F=P.length;if(F>0){for(var G=r.Cartesian3.clone(r.Cartesian3.ZERO,D),Y=Number.NEGATIVE_INFINITY,_=0;_<F;++_){R=s.Matrix3.multiplyByVector(g,s.Matrix3.multiplyByVector(d,P[_],A),A);var j=r.Cartesian3.normalize(r.Cartesian3.subtract(R,n,I),I),H=r.Cartesian3.dot(j,i);H>Y&&(Y=H,G=r.Cartesian3.clone(R,G))}var J=e.cartesianToCartographic(G,k);return Y=r.CesiumMath.clamp(Y,0,1),S=r.Cartesian3.magnitude(r.Cartesian3.subtract(G,n,I))*Math.sqrt(1-Y*Y),S=C?-S:S,J.height=S,e.cartographicToCartesian(J,new r.Cartesian3)}};var F=new r.Cartesian3;m.lineSegmentPlane=function(a,e,n,i){t.defined(i)||(i=new r.Cartesian3);var s=r.Cartesian3.subtract(e,a,F),o=n.normal,u=r.Cartesian3.dot(o,s);if(!(Math.abs(u)<r.CesiumMath.EPSILON6)){var C=r.Cartesian3.dot(o,a),c=-(n.distance+C)/u;if(!(c<0||c>1))return r.Cartesian3.multiplyByScalar(s,c,i),r.Cartesian3.add(a,i,i),i}},m.trianglePlaneIntersection=function(a,t,e,n){var i,s,o=n.normal,u=n.distance,C=r.Cartesian3.dot(o,a)+u<0,c=r.Cartesian3.dot(o,t)+u<0,l=r.Cartesian3.dot(o,e)+u<0,h=0;if(h+=C?1:0,h+=c?1:0,1!==(h+=l?1:0)&&2!==h||(i=new r.Cartesian3,s=new r.Cartesian3),1===h){if(C)return m.lineSegmentPlane(a,t,n,i),m.lineSegmentPlane(a,e,n,s),{positions:[a,t,e,i,s],indices:[0,3,4,1,2,4,1,4,3]};if(c)return m.lineSegmentPlane(t,e,n,i),m.lineSegmentPlane(t,a,n,s),{positions:[a,t,e,i,s],indices:[1,3,4,2,0,4,2,4,3]};if(l)return m.lineSegmentPlane(e,a,n,i),m.lineSegmentPlane(e,t,n,s),{positions:[a,t,e,i,s],indices:[2,3,4,0,1,4,0,4,3]}}else if(2===h){if(!C)return m.lineSegmentPlane(t,a,n,i),m.lineSegmentPlane(e,a,n,s),{positions:[a,t,e,i,s],indices:[1,2,4,1,4,3,0,3,4]};if(!c)return m.lineSegmentPlane(e,t,n,i),m.lineSegmentPlane(a,t,n,s),{positions:[a,t,e,i,s],indices:[2,0,4,2,4,3,1,3,4]};if(!l)return m.lineSegmentPlane(a,e,n,i),m.lineSegmentPlane(t,e,n,s),{positions:[a,t,e,i,s],indices:[0,1,4,0,4,3,2,3,4]}}},a.IntersectionTests=m,a.Ray=f}));
