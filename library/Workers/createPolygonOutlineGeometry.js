/**
 * Cesium - https://github.com/AnalyticalGraphicsInc/cesium
 *
 * Copyright 2011-2017 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md for full licensing details.
 */
define(["./when-4ca4e419","./Check-430b3551","./defineProperties-163ddb68","./Cartesian3-32451e63","./Ellipsoid-d2aa3b12","./Transforms-7b04d7e0","./Matrix4-33464f2b","./RuntimeError-443472b0","./Cartesian2-f49a1383","./FeatureDetection-0d4fee13","./WebGLConstants-2ddfa2f9","./ComponentDatatype-329b9462","./GeometryAttribute-b8faa946","./GeometryAttributes-614c63f8","./AttributeCompression-7809eba4","./GeometryPipeline-f9bdb2cf","./EncodedCartesian3-63b18b5e","./IndexDatatype-153fdd7f","./IntersectionTests-15d018f5","./Plane-84b14a0a","./arrayFill-11a46844","./GeometryInstance-d03f2889","./arrayRemoveDuplicates-c3fd0b84","./EllipsoidTangentPlane-3967708f","./ArcType-51c149e1","./EllipsoidRhumbLine-c004db91","./PolygonPipeline-d25dad97","./PolygonGeometryLibrary-ea4e2ec7"],(function(e,t,i,r,o,n,a,l,s,y,p,d,u,c,f,h,g,m,b,P,E,v,A,_,G,T,H,L){"use strict";var C=[],O=[];function D(e,t,i,r,o){var n,a,l=_.EllipsoidTangentPlane.fromPoints(t,e).projectPointsOntoPlane(t,C);H.PolygonPipeline.computeWindingOrder2D(l)===H.WindingOrder.CLOCKWISE&&(l.reverse(),t=t.slice().reverse());var s=t.length,y=0;if(r)for(n=new Float64Array(2*s*3),a=0;a<s;a++){var p=t[a],f=t[(a+1)%s];n[y++]=p.x,n[y++]=p.y,n[y++]=p.z,n[y++]=f.x,n[y++]=f.y,n[y++]=f.z}else{var h=0;if(o===G.ArcType.GEODESIC)for(a=0;a<s;a++)h+=L.PolygonGeometryLibrary.subdivideLineCount(t[a],t[(a+1)%s],i);else if(o===G.ArcType.RHUMB)for(a=0;a<s;a++)h+=L.PolygonGeometryLibrary.subdivideRhumbLineCount(e,t[a],t[(a+1)%s],i);for(n=new Float64Array(3*h),a=0;a<s;a++){var g;o===G.ArcType.GEODESIC?g=L.PolygonGeometryLibrary.subdivideLine(t[a],t[(a+1)%s],i,O):o===G.ArcType.RHUMB&&(g=L.PolygonGeometryLibrary.subdivideRhumbLine(e,t[a],t[(a+1)%s],i,O));for(var b=g.length,P=0;P<b;++P)n[y++]=g[P]}}var E=2*(s=n.length/3),A=m.IndexDatatype.createTypedArray(s,E);for(y=0,a=0;a<s-1;a++)A[y++]=a,A[y++]=a+1;return A[y++]=s-1,A[y++]=0,new v.GeometryInstance({geometry:new u.Geometry({attributes:new c.GeometryAttributes({position:new u.GeometryAttribute({componentDatatype:d.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:n})}),indices:A,primitiveType:u.PrimitiveType.LINES})})}function I(e,t,i,r,o){var n,a,l=_.EllipsoidTangentPlane.fromPoints(t,e).projectPointsOntoPlane(t,C);H.PolygonPipeline.computeWindingOrder2D(l)===H.WindingOrder.CLOCKWISE&&(l.reverse(),t=t.slice().reverse());var s=t.length,y=new Array(s),p=0;if(r)for(n=new Float64Array(2*s*3*2),a=0;a<s;++a){y[a]=p/3;var f=t[a],h=t[(a+1)%s];n[p++]=f.x,n[p++]=f.y,n[p++]=f.z,n[p++]=h.x,n[p++]=h.y,n[p++]=h.z}else{var g=0;if(o===G.ArcType.GEODESIC)for(a=0;a<s;a++)g+=L.PolygonGeometryLibrary.subdivideLineCount(t[a],t[(a+1)%s],i);else if(o===G.ArcType.RHUMB)for(a=0;a<s;a++)g+=L.PolygonGeometryLibrary.subdivideRhumbLineCount(e,t[a],t[(a+1)%s],i);for(n=new Float64Array(3*g*2),a=0;a<s;++a){var b;y[a]=p/3,o===G.ArcType.GEODESIC?b=L.PolygonGeometryLibrary.subdivideLine(t[a],t[(a+1)%s],i,O):o===G.ArcType.RHUMB&&(b=L.PolygonGeometryLibrary.subdivideRhumbLine(e,t[a],t[(a+1)%s],i,O));for(var P=b.length,E=0;E<P;++E)n[p++]=b[E]}}s=n.length/6;var A=y.length,T=2*(2*s+A),D=m.IndexDatatype.createTypedArray(s,T);for(p=0,a=0;a<s;++a)D[p++]=a,D[p++]=(a+1)%s,D[p++]=a+s,D[p++]=(a+1)%s+s;for(a=0;a<A;a++){var I=y[a];D[p++]=I,D[p++]=I+s}return new v.GeometryInstance({geometry:new u.Geometry({attributes:new c.GeometryAttributes({position:new u.GeometryAttribute({componentDatatype:d.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:n})}),indices:D,primitiveType:u.PrimitiveType.LINES})})}function w(r){if(t.Check.typeOf.object("options",r),t.Check.typeOf.object("options.polygonHierarchy",r.polygonHierarchy),r.perPositionHeight&&e.defined(r.height))throw new t.DeveloperError("Cannot use both options.perPositionHeight and options.height");if(e.defined(r.arcType)&&r.arcType!==G.ArcType.GEODESIC&&r.arcType!==G.ArcType.RHUMB)throw new t.DeveloperError("Invalid arcType. Valid options are ArcType.GEODESIC and ArcType.RHUMB.");var n=r.polygonHierarchy,a=e.defaultValue(r.ellipsoid,o.Ellipsoid.WGS84),l=e.defaultValue(r.granularity,i.CesiumMath.RADIANS_PER_DEGREE),s=e.defaultValue(r.perPositionHeight,!1),y=s&&e.defined(r.extrudedHeight),p=e.defaultValue(r.arcType,G.ArcType.GEODESIC),d=e.defaultValue(r.height,0),u=e.defaultValue(r.extrudedHeight,d);if(!y){var c=Math.max(d,u);u=Math.min(d,u),d=c}this._ellipsoid=o.Ellipsoid.clone(a),this._granularity=l,this._height=d,this._extrudedHeight=u,this._arcType=p,this._polygonHierarchy=n,this._perPositionHeight=s,this._perPositionHeightExtrude=y,this._offsetAttribute=r.offsetAttribute,this._workerName="createPolygonOutlineGeometry",this.packedLength=L.PolygonGeometryLibrary.computeHierarchyPackedLength(n)+o.Ellipsoid.packedLength+8}w.pack=function(i,r,n){return t.Check.typeOf.object("value",i),t.Check.defined("array",r),n=e.defaultValue(n,0),n=L.PolygonGeometryLibrary.packPolygonHierarchy(i._polygonHierarchy,r,n),o.Ellipsoid.pack(i._ellipsoid,r,n),n+=o.Ellipsoid.packedLength,r[n++]=i._height,r[n++]=i._extrudedHeight,r[n++]=i._granularity,r[n++]=i._perPositionHeightExtrude?1:0,r[n++]=i._perPositionHeight?1:0,r[n++]=i._arcType,r[n++]=e.defaultValue(i._offsetAttribute,-1),r[n]=i.packedLength,r};var x=o.Ellipsoid.clone(o.Ellipsoid.UNIT_SPHERE),k={polygonHierarchy:{}};return w.unpack=function(i,r,n){t.Check.defined("array",i),r=e.defaultValue(r,0);var a=L.PolygonGeometryLibrary.unpackPolygonHierarchy(i,r);r=a.startingIndex,delete a.startingIndex;var l=o.Ellipsoid.unpack(i,r,x);r+=o.Ellipsoid.packedLength;var s=i[r++],y=i[r++],p=i[r++],d=1===i[r++],u=1===i[r++],c=i[r++],f=i[r++],h=i[r];return e.defined(n)||(n=new w(k)),n._polygonHierarchy=a,n._ellipsoid=o.Ellipsoid.clone(l,n._ellipsoid),n._height=s,n._extrudedHeight=y,n._granularity=p,n._perPositionHeight=u,n._perPositionHeightExtrude=d,n._arcType=c,n._offsetAttribute=-1===f?void 0:f,n.packedLength=h,n},w.fromPositions=function(i){return i=e.defaultValue(i,e.defaultValue.EMPTY_OBJECT),t.Check.defined("options.positions",i.positions),new w({polygonHierarchy:{positions:i.positions},height:i.height,extrudedHeight:i.extrudedHeight,ellipsoid:i.ellipsoid,granularity:i.granularity,perPositionHeight:i.perPositionHeight,arcType:i.arcType,offsetAttribute:i.offsetAttribute})},w.createGeometry=function(t){var r=t._ellipsoid,o=t._granularity,a=t._polygonHierarchy,l=t._perPositionHeight,s=t._arcType,y=L.PolygonGeometryLibrary.polygonOutlinesFromHierarchy(a,!l,r);if(0!==y.length){var p,c,f,g=[],m=i.CesiumMath.chordLength(o,r.maximumRadius),b=t._height,P=t._extrudedHeight;if(t._perPositionHeightExtrude||!i.CesiumMath.equalsEpsilon(b,P,0,i.CesiumMath.EPSILON2))for(f=0;f<y.length;f++){if((p=I(r,y[f],m,l,s)).geometry=L.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(p.geometry,b,P,r,l),e.defined(t._offsetAttribute)){var v=p.geometry.attributes.position.values.length/3,A=new Uint8Array(v);t._offsetAttribute===u.GeometryOffsetAttribute.TOP?A=E.arrayFill(A,1,0,v/2):(c=t._offsetAttribute===u.GeometryOffsetAttribute.NONE?0:1,A=E.arrayFill(A,c)),p.geometry.attributes.applyOffset=new u.GeometryAttribute({componentDatatype:d.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:A})}g.push(p)}else for(f=0;f<y.length;f++){if((p=D(r,y[f],m,l,s)).geometry.attributes.position.values=H.PolygonPipeline.scaleToGeodeticHeight(p.geometry.attributes.position.values,b,r,!l),e.defined(t._offsetAttribute)){var _=p.geometry.attributes.position.values.length,G=new Uint8Array(_/3);c=t._offsetAttribute===u.GeometryOffsetAttribute.NONE?0:1,E.arrayFill(G,c),p.geometry.attributes.applyOffset=new u.GeometryAttribute({componentDatatype:d.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:G})}g.push(p)}var T=h.GeometryPipeline.combineInstances(g)[0],C=n.BoundingSphere.fromVertices(T.attributes.position.values);return new u.Geometry({attributes:T.attributes,indices:T.indices,primitiveType:T.primitiveType,boundingSphere:C,offsetAttribute:t._offsetAttribute})}},function(t,i){return e.defined(i)&&(t=w.unpack(t,i)),t._ellipsoid=o.Ellipsoid.clone(t._ellipsoid),w.createGeometry(t)}}));
