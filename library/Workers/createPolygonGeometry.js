/**
 * Cesium - https://github.com/AnalyticalGraphicsInc/cesium
 *
 * Copyright 2011-2017 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md for full licensing details.
 */
define(["./when-4ca4e419","./Check-430b3551","./defineProperties-163ddb68","./Cartesian3-32451e63","./Ellipsoid-d2aa3b12","./Transforms-7b04d7e0","./Matrix4-33464f2b","./RuntimeError-443472b0","./Cartesian2-f49a1383","./FeatureDetection-0d4fee13","./WebGLConstants-2ddfa2f9","./ComponentDatatype-329b9462","./GeometryAttribute-b8faa946","./GeometryAttributes-614c63f8","./AttributeCompression-7809eba4","./GeometryPipeline-f9bdb2cf","./EncodedCartesian3-63b18b5e","./IndexDatatype-153fdd7f","./IntersectionTests-15d018f5","./Plane-84b14a0a","./arrayFill-11a46844","./VertexFormat-a4fe3a21","./GeometryInstance-d03f2889","./arrayRemoveDuplicates-c3fd0b84","./BoundingRectangle-c080f887","./EllipsoidTangentPlane-3967708f","./ArcType-51c149e1","./EllipsoidRhumbLine-c004db91","./PolygonPipeline-d25dad97","./PolygonGeometryLibrary-ea4e2ec7","./EllipsoidGeodesic-c57b5e5c"],(function(e,t,r,o,a,i,n,s,l,p,u,c,y,d,g,m,h,f,b,v,_,P,C,T,w,x,A,E,I,G,H){"use strict";var V=new a.Cartographic,F=new a.Cartographic;function N(e,t,r,o){var a=o.cartesianToCartographic(e,V).height,i=o.cartesianToCartographic(t,F);i.height=a,o.cartographicToCartesian(i,t);var n=o.cartesianToCartographic(r,F);n.height=a-100,o.cartographicToCartesian(n,r)}var O=new w.BoundingRectangle,R=new o.Cartesian3,D=new o.Cartesian3,L=new o.Cartesian3,M=new o.Cartesian3,S=new o.Cartesian3,k=new o.Cartesian3,B=new o.Cartesian3,z=new o.Cartesian3,U=new o.Cartesian3,Y=new l.Cartesian2,W=new l.Cartesian2,j=new o.Cartesian3,Q=new i.Quaternion,q=new n.Matrix3,K=new n.Matrix3;function Z(t){var a=t.vertexFormat,s=t.geometry,p=t.shadowVolume,u=s.attributes.position.values,d=u.length,g=t.wall,m=t.top||g,h=t.bottom||g;if(a.st||a.normal||a.tangent||a.bitangent||p){var f=t.boundingRectangle,b=t.tangentPlane,v=t.ellipsoid,P=t.stRotation,C=t.perPositionHeight,T=Y;T.x=f.x,T.y=f.y;var w,x=a.st?new Float32Array(d/3*2):void 0;a.normal&&(w=C&&m&&!g?s.attributes.normal.values:new Float32Array(d));var A=a.tangent?new Float32Array(d):void 0,E=a.bitangent?new Float32Array(d):void 0,I=p?new Float32Array(d):void 0,G=0,H=0,V=D,F=L,O=M,Z=!0,J=q,X=K;if(0!==P){var $=i.Quaternion.fromAxisAngle(b._plane.normal,P,Q);J=n.Matrix3.fromQuaternion($,J),$=i.Quaternion.fromAxisAngle(b._plane.normal,-P,Q),X=n.Matrix3.fromQuaternion($,X)}else J=n.Matrix3.clone(n.Matrix3.IDENTITY,J),X=n.Matrix3.clone(n.Matrix3.IDENTITY,X);var ee=0,te=0;m&&h&&(ee=d/2,te=d/3,d/=2);for(var re=0;re<d;re+=3){var oe=o.Cartesian3.fromArray(u,re,j);if(a.st){var ae=n.Matrix3.multiplyByVector(J,oe,R);ae=v.scaleToGeodeticSurface(ae,ae);var ie=b.projectPointOntoPlane(ae,W);l.Cartesian2.subtract(ie,T,ie);var ne=r.CesiumMath.clamp(ie.x/f.width,0,1),se=r.CesiumMath.clamp(ie.y/f.height,0,1);h&&(x[G+te]=ne,x[G+1+te]=se),m&&(x[G]=ne,x[G+1]=se),G+=2}if(a.normal||a.tangent||a.bitangent||p){var le=H+1,pe=H+2;if(g){if(re+3<d){var ue=o.Cartesian3.fromArray(u,re+3,S);if(Z){var ce=o.Cartesian3.fromArray(u,re+d,k);C&&N(oe,ue,ce,v),o.Cartesian3.subtract(ue,oe,ue),o.Cartesian3.subtract(ce,oe,ce),V=o.Cartesian3.normalize(o.Cartesian3.cross(ce,ue,V),V),Z=!1}o.Cartesian3.equalsEpsilon(ue,oe,r.CesiumMath.EPSILON10)&&(Z=!0)}(a.tangent||a.bitangent)&&(O=v.geodeticSurfaceNormal(oe,O),a.tangent&&(F=o.Cartesian3.normalize(o.Cartesian3.cross(O,V,F),F)))}else V=v.geodeticSurfaceNormal(oe,V),(a.tangent||a.bitangent)&&(C&&(B=o.Cartesian3.fromArray(w,H,B),z=o.Cartesian3.cross(o.Cartesian3.UNIT_Z,B,z),z=o.Cartesian3.normalize(n.Matrix3.multiplyByVector(X,z,z),z),a.bitangent&&(U=o.Cartesian3.normalize(o.Cartesian3.cross(B,z,U),U))),F=o.Cartesian3.cross(o.Cartesian3.UNIT_Z,V,F),F=o.Cartesian3.normalize(n.Matrix3.multiplyByVector(X,F,F),F),a.bitangent&&(O=o.Cartesian3.normalize(o.Cartesian3.cross(V,F,O),O)));a.normal&&(t.wall?(w[H+ee]=V.x,w[le+ee]=V.y,w[pe+ee]=V.z):h&&(w[H+ee]=-V.x,w[le+ee]=-V.y,w[pe+ee]=-V.z),(m&&!C||g)&&(w[H]=V.x,w[le]=V.y,w[pe]=V.z)),p&&(g&&(V=v.geodeticSurfaceNormal(oe,V)),I[H+ee]=-V.x,I[le+ee]=-V.y,I[pe+ee]=-V.z),a.tangent&&(t.wall?(A[H+ee]=F.x,A[le+ee]=F.y,A[pe+ee]=F.z):h&&(A[H+ee]=-F.x,A[le+ee]=-F.y,A[pe+ee]=-F.z),m&&(C?(A[H]=z.x,A[le]=z.y,A[pe]=z.z):(A[H]=F.x,A[le]=F.y,A[pe]=F.z))),a.bitangent&&(h&&(E[H+ee]=O.x,E[le+ee]=O.y,E[pe+ee]=O.z),m&&(C?(E[H]=U.x,E[le]=U.y,E[pe]=U.z):(E[H]=O.x,E[le]=O.y,E[pe]=O.z))),H+=3}}a.st&&(s.attributes.st=new y.GeometryAttribute({componentDatatype:c.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:x})),a.normal&&(s.attributes.normal=new y.GeometryAttribute({componentDatatype:c.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:w})),a.tangent&&(s.attributes.tangent=new y.GeometryAttribute({componentDatatype:c.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:A})),a.bitangent&&(s.attributes.bitangent=new y.GeometryAttribute({componentDatatype:c.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:E})),p&&(s.attributes.extrudeDirection=new y.GeometryAttribute({componentDatatype:c.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:I}))}if(t.extrude&&e.defined(t.offsetAttribute)){var ye=u.length/3,de=new Uint8Array(ye);if(t.offsetAttribute===y.GeometryOffsetAttribute.TOP)m&&h||g?de=_.arrayFill(de,1,0,ye/2):m&&(de=_.arrayFill(de,1));else{var ge=t.offsetAttribute===y.GeometryOffsetAttribute.NONE?0:1;de=_.arrayFill(de,ge)}s.attributes.applyOffset=new y.GeometryAttribute({componentDatatype:c.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:de})}return s}var J=new a.Cartographic,X=new a.Cartographic,$={west:0,east:0},ee=new H.EllipsoidGeodesic;function te(t,o,a,i,n){if(n=e.defaultValue(n,new l.Rectangle),!e.defined(t)||t.length<3)return n.west=0,n.north=0,n.south=0,n.east=0,n;if(a===A.ArcType.RHUMB)return l.Rectangle.fromCartesianArray(t,o,n);ee.ellipsoid.equals(o)||(ee=new H.EllipsoidGeodesic(void 0,void 0,o)),n.west=Number.POSITIVE_INFINITY,n.east=Number.NEGATIVE_INFINITY,n.south=Number.POSITIVE_INFINITY,n.north=Number.NEGATIVE_INFINITY,$.west=Number.POSITIVE_INFINITY,$.east=Number.NEGATIVE_INFINITY;for(var s,p=1/r.CesiumMath.chordLength(i,o.maximumRadius),u=t.length,c=o.cartesianToCartographic(t[0],X),y=J,d=1;d<u;d++)s=y,y=c,c=o.cartesianToCartographic(t[d],s),ee.setEndPoints(y,c),oe(ee,p,n,$);return s=y,y=c,c=o.cartesianToCartographic(t[0],s),ee.setEndPoints(y,c),oe(ee,p,n,$),n.east-n.west>$.west-$.east&&(n.east=$.east,n.west=$.west),n}var re=new a.Cartographic;function oe(e,t,r,o){for(var a=e.surfaceDistance,i=Math.ceil(a*t),n=i>0?a/(i-1):Number.POSITIVE_INFINITY,s=0,l=0;l<i;l++){var p=e.interpolateUsingSurfaceDistance(s,re);s+=n;var u=p.longitude,c=p.latitude;r.west=Math.min(r.west,u),r.east=Math.max(r.east,u),r.south=Math.min(r.south,c),r.north=Math.max(r.north,c),o.west=u>0?Math.min(u,o.west):o.west,o.east=u<0?Math.max(u,o.east):o.east}}var ae=[];function ie(e,t,r,o,a,i,n,s,l){var p,u={walls:[]};if(i||n){var c,y,d=G.PolygonGeometryLibrary.createGeometryFromPositions(e,t,r,a,s,l),g=d.attributes.position.values,m=d.indices;if(i&&n){var h=g.concat(g);c=h.length/3,(y=f.IndexDatatype.createTypedArray(c,2*m.length)).set(m);var b=m.length,v=c/2;for(p=0;p<b;p+=3){var _=y[p]+v,P=y[p+1]+v,T=y[p+2]+v;y[p+b]=T,y[p+1+b]=P,y[p+2+b]=_}if(d.attributes.position.values=h,a&&s.normal){var w=d.attributes.normal.values;d.attributes.normal.values=new Float32Array(h.length),d.attributes.normal.values.set(w)}d.indices=y}else if(n){for(c=g.length/3,y=f.IndexDatatype.createTypedArray(c,m.length),p=0;p<m.length;p+=3)y[p]=m[p+2],y[p+1]=m[p+1],y[p+2]=m[p];d.indices=y}u.topAndBottom=new C.GeometryInstance({geometry:d})}var A=o.outerRing,E=x.EllipsoidTangentPlane.fromPoints(A,e),H=E.projectPointsOntoPlane(A,ae),V=I.PolygonPipeline.computeWindingOrder2D(H);V===I.WindingOrder.CLOCKWISE&&(A=A.slice().reverse());var F=G.PolygonGeometryLibrary.computeWallGeometry(A,e,r,a,l);u.walls.push(new C.GeometryInstance({geometry:F}));var N=o.holes;for(p=0;p<N.length;p++){var O=N[p];H=(E=x.EllipsoidTangentPlane.fromPoints(O,e)).projectPointsOntoPlane(O,ae),(V=I.PolygonPipeline.computeWindingOrder2D(H))===I.WindingOrder.COUNTER_CLOCKWISE&&(O=O.slice().reverse()),F=G.PolygonGeometryLibrary.computeWallGeometry(O,e,r,a,l),u.walls.push(new C.GeometryInstance({geometry:F}))}return u}function ne(o){if(t.Check.typeOf.object("options",o),t.Check.typeOf.object("options.polygonHierarchy",o.polygonHierarchy),e.defined(o.perPositionHeight)&&o.perPositionHeight&&e.defined(o.height))throw new t.DeveloperError("Cannot use both options.perPositionHeight and options.height");if(e.defined(o.arcType)&&o.arcType!==A.ArcType.GEODESIC&&o.arcType!==A.ArcType.RHUMB)throw new t.DeveloperError("Invalid arcType. Valid options are ArcType.GEODESIC and ArcType.RHUMB.");var i=o.polygonHierarchy,n=e.defaultValue(o.vertexFormat,P.VertexFormat.DEFAULT),s=e.defaultValue(o.ellipsoid,a.Ellipsoid.WGS84),l=e.defaultValue(o.granularity,r.CesiumMath.RADIANS_PER_DEGREE),p=e.defaultValue(o.stRotation,0),u=e.defaultValue(o.perPositionHeight,!1),c=u&&e.defined(o.extrudedHeight),y=e.defaultValue(o.height,0),d=e.defaultValue(o.extrudedHeight,y);if(!c){var g=Math.max(y,d);d=Math.min(y,d),y=g}this._vertexFormat=P.VertexFormat.clone(n),this._ellipsoid=a.Ellipsoid.clone(s),this._granularity=l,this._stRotation=p,this._height=y,this._extrudedHeight=d,this._closeTop=e.defaultValue(o.closeTop,!0),this._closeBottom=e.defaultValue(o.closeBottom,!0),this._polygonHierarchy=i,this._perPositionHeight=u,this._perPositionHeightExtrude=c,this._shadowVolume=e.defaultValue(o.shadowVolume,!1),this._workerName="createPolygonGeometry",this._offsetAttribute=o.offsetAttribute,this._arcType=e.defaultValue(o.arcType,A.ArcType.GEODESIC),this._rectangle=void 0,this._textureCoordinateRotationPoints=void 0,this.packedLength=G.PolygonGeometryLibrary.computeHierarchyPackedLength(i)+a.Ellipsoid.packedLength+P.VertexFormat.packedLength+12}ne.fromPositions=function(r){return r=e.defaultValue(r,e.defaultValue.EMPTY_OBJECT),t.Check.defined("options.positions",r.positions),new ne({polygonHierarchy:{positions:r.positions},height:r.height,extrudedHeight:r.extrudedHeight,vertexFormat:r.vertexFormat,stRotation:r.stRotation,ellipsoid:r.ellipsoid,granularity:r.granularity,perPositionHeight:r.perPositionHeight,closeTop:r.closeTop,closeBottom:r.closeBottom,offsetAttribute:r.offsetAttribute,arcType:r.arcType})},ne.pack=function(r,o,i){return t.Check.typeOf.object("value",r),t.Check.defined("array",o),i=e.defaultValue(i,0),i=G.PolygonGeometryLibrary.packPolygonHierarchy(r._polygonHierarchy,o,i),a.Ellipsoid.pack(r._ellipsoid,o,i),i+=a.Ellipsoid.packedLength,P.VertexFormat.pack(r._vertexFormat,o,i),i+=P.VertexFormat.packedLength,o[i++]=r._height,o[i++]=r._extrudedHeight,o[i++]=r._granularity,o[i++]=r._stRotation,o[i++]=r._perPositionHeightExtrude?1:0,o[i++]=r._perPositionHeight?1:0,o[i++]=r._closeTop?1:0,o[i++]=r._closeBottom?1:0,o[i++]=r._shadowVolume?1:0,o[i++]=e.defaultValue(r._offsetAttribute,-1),o[i++]=r._arcType,o[i]=r.packedLength,o};var se=a.Ellipsoid.clone(a.Ellipsoid.UNIT_SPHERE),le=new P.VertexFormat,pe={polygonHierarchy:{}};return ne.unpack=function(r,o,i){t.Check.defined("array",r),o=e.defaultValue(o,0);var n=G.PolygonGeometryLibrary.unpackPolygonHierarchy(r,o);o=n.startingIndex,delete n.startingIndex;var s=a.Ellipsoid.unpack(r,o,se);o+=a.Ellipsoid.packedLength;var l=P.VertexFormat.unpack(r,o,le);o+=P.VertexFormat.packedLength;var p=r[o++],u=r[o++],c=r[o++],y=r[o++],d=1===r[o++],g=1===r[o++],m=1===r[o++],h=1===r[o++],f=1===r[o++],b=r[o++],v=r[o++],_=r[o];return e.defined(i)||(i=new ne(pe)),i._polygonHierarchy=n,i._ellipsoid=a.Ellipsoid.clone(s,i._ellipsoid),i._vertexFormat=P.VertexFormat.clone(l,i._vertexFormat),i._height=p,i._extrudedHeight=u,i._granularity=c,i._stRotation=y,i._perPositionHeightExtrude=d,i._perPositionHeight=g,i._closeTop=m,i._closeBottom=h,i._shadowVolume=f,i._offsetAttribute=-1===b?void 0:b,i._arcType=v,i.packedLength=_,i},ne.computeRectangle=function(o,i){t.Check.typeOf.object("options",o),t.Check.typeOf.object("options.polygonHierarchy",o.polygonHierarchy);var n=e.defaultValue(o.granularity,r.CesiumMath.RADIANS_PER_DEGREE),s=e.defaultValue(o.arcType,A.ArcType.GEODESIC);if(s!==A.ArcType.GEODESIC&&s!==A.ArcType.RHUMB)throw new t.DeveloperError("Invalid arcType. Valid options are ArcType.GEODESIC and ArcType.RHUMB.");var l=o.polygonHierarchy,p=e.defaultValue(o.ellipsoid,a.Ellipsoid.WGS84);return te(l.positions,p,s,n,i)},ne.createGeometry=function(t){var o=t._vertexFormat,a=t._ellipsoid,n=t._granularity,s=t._stRotation,l=t._polygonHierarchy,p=t._perPositionHeight,u=t._closeTop,d=t._closeBottom,g=t._arcType,h=l.positions;if(!(h.length<3)){var b=x.EllipsoidTangentPlane.fromPoints(h,a),v=G.PolygonGeometryLibrary.polygonsFromHierarchy(l,b.projectPointsOntoPlane.bind(b),!p,a),P=v.hierarchy,T=v.polygons;if(0!==P.length){h=P[0].outerRing;var w,A=G.PolygonGeometryLibrary.computeBoundingRectangle(b.plane.normal,b.projectPointOntoPlane.bind(b),h,s,O),E=[],H=t._height,V=t._extrudedHeight,F={perPositionHeight:p,vertexFormat:o,geometry:void 0,tangentPlane:b,boundingRectangle:A,ellipsoid:a,stRotation:s,bottom:!1,top:!0,wall:!1,extrude:!1,arcType:g};if(t._perPositionHeightExtrude||!r.CesiumMath.equalsEpsilon(H,V,0,r.CesiumMath.EPSILON2))for(F.extrude=!0,F.top=u,F.bottom=d,F.shadowVolume=t._shadowVolume,F.offsetAttribute=t._offsetAttribute,w=0;w<T.length;w++){var N,R=ie(a,T[w],n,P[w],p,u,d,o,g);u&&d?(N=R.topAndBottom,F.geometry=G.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(N.geometry,H,V,a,p)):u?((N=R.topAndBottom).geometry.attributes.position.values=I.PolygonPipeline.scaleToGeodeticHeight(N.geometry.attributes.position.values,H,a,!p),F.geometry=N.geometry):d&&((N=R.topAndBottom).geometry.attributes.position.values=I.PolygonPipeline.scaleToGeodeticHeight(N.geometry.attributes.position.values,V,a,!0),F.geometry=N.geometry),(u||d)&&(F.wall=!1,N.geometry=Z(F),E.push(N));var D=R.walls;F.wall=!0;for(var L=0;L<D.length;L++){var M=D[L];F.geometry=G.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(M.geometry,H,V,a,p),M.geometry=Z(F),E.push(M)}}else for(w=0;w<T.length;w++){var S=new C.GeometryInstance({geometry:G.PolygonGeometryLibrary.createGeometryFromPositions(a,T[w],n,p,o,g)});if(S.geometry.attributes.position.values=I.PolygonPipeline.scaleToGeodeticHeight(S.geometry.attributes.position.values,H,a,!p),F.geometry=S.geometry,S.geometry=Z(F),e.defined(t._offsetAttribute)){var k=S.geometry.attributes.position.values.length,B=new Uint8Array(k/3),z=t._offsetAttribute===y.GeometryOffsetAttribute.NONE?0:1;_.arrayFill(B,z),S.geometry.attributes.applyOffset=new y.GeometryAttribute({componentDatatype:c.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:B})}E.push(S)}var U=m.GeometryPipeline.combineInstances(E)[0];U.attributes.position.values=new Float64Array(U.attributes.position.values),U.indices=f.IndexDatatype.createTypedArray(U.attributes.position.values.length/3,U.indices);var Y=U.attributes,W=i.BoundingSphere.fromVertices(Y.position.values);return o.position||delete Y.position,new y.Geometry({attributes:Y,indices:U.indices,primitiveType:U.primitiveType,boundingSphere:W,offsetAttribute:t._offsetAttribute})}}},ne.createShadowVolume=function(e,t,r){var o=e._granularity,a=e._ellipsoid,i=t(o,a),n=r(o,a);return new ne({polygonHierarchy:e._polygonHierarchy,ellipsoid:a,stRotation:e._stRotation,granularity:o,perPositionHeight:!1,extrudedHeight:i,height:n,vertexFormat:P.VertexFormat.POSITION_ONLY,shadowVolume:!0,arcType:e._arcType})},r.defineProperties(ne.prototype,{rectangle:{get:function(){if(!e.defined(this._rectangle)){var t=this._polygonHierarchy.positions;this._rectangle=te(t,this._ellipsoid,this._arcType,this._granularity)}return this._rectangle}},textureCoordinateRotationPoints:{get:function(){return e.defined(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=function(e){var t=-e._stRotation;if(0===t)return[0,0,0,1,1,0];var r=e._ellipsoid,o=e._polygonHierarchy.positions,a=e.rectangle;return y.Geometry._textureCoordinateRotationPoints(o,t,r,a)}(this)),this._textureCoordinateRotationPoints}}}),function(t,r){return e.defined(r)&&(t=ne.unpack(t,r)),t._ellipsoid=a.Ellipsoid.clone(t._ellipsoid),ne.createGeometry(t)}}));
