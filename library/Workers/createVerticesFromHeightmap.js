/**
 * Cesium - https://github.com/AnalyticalGraphicsInc/cesium
 *
 * Copyright 2011-2017 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md for full licensing details.
 */
define(["./when-4ca4e419","./Check-430b3551","./defineProperties-163ddb68","./Cartesian3-32451e63","./Ellipsoid-d2aa3b12","./Transforms-7b04d7e0","./Matrix4-33464f2b","./RuntimeError-443472b0","./Cartesian2-f49a1383","./FeatureDetection-0d4fee13","./WebGLConstants-2ddfa2f9","./ComponentDatatype-329b9462","./AttributeCompression-7809eba4","./IntersectionTests-15d018f5","./Plane-84b14a0a","./WebMercatorProjection-72bc39e7","./createTaskProcessorWorker","./EllipsoidTangentPlane-3967708f","./OrientedBoundingBox-51e874ad","./EllipsoidalOccluder-bf5748df","./TerrainEncoding-5ed40ec6"],(function(e,i,t,r,n,a,o,d,u,l,s,c,h,g,m,f,T,p,E,I,v){"use strict";var b={};b.DEFAULT_STRUCTURE=e.freezeObject({heightScale:1,heightOffset:0,elementsPerHeight:1,stride:1,elementMultiplier:256,isBigEndian:!1});var w=new r.Cartesian3,C=new o.Matrix4,S=new r.Cartesian3,M=new r.Cartesian3;return b.computeVertices=function(d){if(!e.defined(d)||!e.defined(d.heightmap))throw new i.DeveloperError("options.heightmap is required.");if(!e.defined(d.width)||!e.defined(d.height))throw new i.DeveloperError("options.width and options.height are required.");if(!e.defined(d.nativeRectangle))throw new i.DeveloperError("options.nativeRectangle is required.");if(!e.defined(d.skirtHeight))throw new i.DeveloperError("options.skirtHeight is required.");var l,s,c,h,g=Math.cos,m=Math.sin,T=Math.sqrt,R=Math.atan,N=Math.exp,U=t.CesiumMath.PI_OVER_TWO,x=t.CesiumMath.toRadians,P=d.heightmap,A=d.width,V=d.height,B=d.skirtHeight,F=e.defaultValue(d.isGeographic,!0),O=e.defaultValue(d.ellipsoid,n.Ellipsoid.WGS84),_=1/O.maximumRadius,D=d.nativeRectangle,H=d.rectangle;e.defined(H)?(l=H.west,s=H.south,c=H.east,h=H.north):F?(l=x(D.west),s=x(D.south),c=x(D.east),h=x(D.north)):(l=D.west*_,s=U-2*R(N(-D.south*_)),c=D.east*_,h=U-2*R(N(-D.north*_)));var y=d.relativeToCenter,L=e.defined(y);y=L?y:r.Cartesian3.ZERO;var W=e.defaultValue(d.exaggeration,1),k=e.defaultValue(d.includeWebMercatorT,!1),Y=e.defaultValue(d.structure,b.DEFAULT_STRUCTURE),q=e.defaultValue(Y.heightScale,b.DEFAULT_STRUCTURE.heightScale),z=e.defaultValue(Y.heightOffset,b.DEFAULT_STRUCTURE.heightOffset),G=e.defaultValue(Y.elementsPerHeight,b.DEFAULT_STRUCTURE.elementsPerHeight),j=e.defaultValue(Y.stride,b.DEFAULT_STRUCTURE.stride),Z=e.defaultValue(Y.elementMultiplier,b.DEFAULT_STRUCTURE.elementMultiplier),J=e.defaultValue(Y.isBigEndian,b.DEFAULT_STRUCTURE.isBigEndian),K=u.Rectangle.computeWidth(D),Q=u.Rectangle.computeHeight(D),X=K/(A-1),$=Q/(V-1);F||(K*=_,Q*=_);var ee,ie,te=O.radiiSquared,re=te.x,ne=te.y,ae=te.z,oe=65536,de=-65536,ue=a.Transforms.eastNorthUpToFixedFrame(y,O),le=o.Matrix4.inverseTransformation(ue,C);k&&(ee=f.WebMercatorProjection.geodeticLatitudeToMercatorAngle(s),ie=1/(f.WebMercatorProjection.geodeticLatitudeToMercatorAngle(h)-ee));var se=S;se.x=Number.POSITIVE_INFINITY,se.y=Number.POSITIVE_INFINITY,se.z=Number.POSITIVE_INFINITY;var ce=M;ce.x=Number.NEGATIVE_INFINITY,ce.y=Number.NEGATIVE_INFINITY,ce.z=Number.NEGATIVE_INFINITY;var he=Number.POSITIVE_INFINITY,ge=(A+(B>0?2:0))*(V+(B>0?2:0)),me=new Array(ge),fe=new Array(ge),Te=new Array(ge),pe=k?new Array(ge):[],Ee=0,Ie=V,ve=0,be=A;B>0&&(--Ee,++Ie,--ve,++be);for(var we=0,Ce=Ee;Ce<Ie;++Ce){var Se=Ce;Se<0&&(Se=0),Se>=V&&(Se=V-1);var Me,Re=D.north-$*Se,Ne=g(Re=F?x(Re):U-2*R(N(-Re*_))),Ue=m(Re),xe=ae*Ue,Pe=(Re-s)/(h-s);Pe=t.CesiumMath.clamp(Pe,0,1),k&&(Me=(f.WebMercatorProjection.geodeticLatitudeToMercatorAngle(Re)-ee)*ie);for(var Ae=ve;Ae<be;++Ae){var Ve=Ae;Ve<0&&(Ve=0),Ve>=A&&(Ve=A-1);var Be=D.west+X*Ve;F?Be=x(Be):Be*=_;var Fe,Oe,_e=Se*(A*j)+Ve*j;if(1===G)Fe=P[_e];else if(Fe=0,J)for(Oe=0;Oe<G;++Oe)Fe=Fe*Z+P[_e+Oe];else for(Oe=G-1;Oe>=0;--Oe)Fe=Fe*Z+P[_e+Oe];Fe=(Fe*q+z)*W;var De=(Be-l)/(c-l);if(De=t.CesiumMath.clamp(De,0,1),Te[we]=new u.Cartesian2(De,Pe),de=Math.max(de,Fe),oe=Math.min(oe,Fe),Ae!==Ve||Ce!==Se){Ae<0?Be-=1e-5*K:Be+=1e-5*K,Ce<0?Re+=1e-5*Q:Re-=1e-5*Q,Ne=g(Re),xe=ae*(Ue=m(Re)),Fe-=B}var He=Ne*g(Be),ye=Ne*m(Be),Le=re*He,We=ne*ye,ke=1/T(Le*He+We*ye+xe*Ue),Ye=Le*ke,qe=We*ke,ze=xe*ke,Ge=new r.Cartesian3;Ge.x=Ye+He*Fe,Ge.y=qe+ye*Fe,Ge.z=ze+Ue*Fe,me[we]=Ge,fe[we]=Fe,k&&(pe[we]=Me),we++,o.Matrix4.multiplyByPoint(le,Ge,w),r.Cartesian3.minimumByComponent(w,se,se),r.Cartesian3.maximumByComponent(w,ce,ce),he=Math.min(he,Fe)}}var je,Ze,Je=a.BoundingSphere.fromPoints(me);(e.defined(H)&&H.width<t.CesiumMath.PI_OVER_TWO+t.CesiumMath.EPSILON5&&(je=E.OrientedBoundingBox.fromRectangle(H,oe,de,O)),L)&&(Ze=new I.EllipsoidalOccluder(O).computeHorizonCullingPoint(y,me));for(var Ke=new p.AxisAlignedBoundingBox(se,ce,y),Qe=new v.TerrainEncoding(Ke,he,de,ue,!1,k),Xe=new Float32Array(ge*Qe.getStride()),$e=0,ei=0;ei<ge;++ei)$e=Qe.encode(Xe,$e,me[ei],Te[ei],fe[ei],void 0,pe[ei]);return{vertices:Xe,maximumHeight:de,minimumHeight:oe,encoding:Qe,boundingSphere3D:Je,orientedBoundingBox:je,occludeePointInScaledSpace:Ze}},T((function(e,i){var t=e.width,r=e.height;e.skirtHeight>0&&(t+=2,r+=2),e.ellipsoid=n.Ellipsoid.clone(e.ellipsoid),e.rectangle=u.Rectangle.clone(e.rectangle);var a=b.computeVertices(e),o=a.vertices;return i.push(o.buffer),{vertices:o.buffer,numberOfAttributes:a.encoding.getStride(),minimumHeight:a.minimumHeight,maximumHeight:a.maximumHeight,gridWidth:t,gridHeight:r,boundingSphere3D:a.boundingSphere3D,orientedBoundingBox:a.orientedBoundingBox,occludeePointInScaledSpace:a.occludeePointInScaledSpace,encoding:a.encoding}}))}));
