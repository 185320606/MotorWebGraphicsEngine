/**
 * Cesium - https://github.com/AnalyticalGraphicsInc/cesium
 *
 * Copyright 2011-2017 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md for full licensing details.
 */
define(["./when-4ca4e419","./Check-430b3551","./defineProperties-163ddb68","./Cartesian3-32451e63","./Ellipsoid-d2aa3b12","./Transforms-7b04d7e0","./Matrix4-33464f2b","./RuntimeError-443472b0","./Cartesian2-f49a1383","./FeatureDetection-0d4fee13","./WebGLConstants-2ddfa2f9","./ComponentDatatype-329b9462","./GeometryAttribute-b8faa946","./GeometryAttributes-614c63f8","./IndexDatatype-153fdd7f","./createTaskProcessorWorker","./arrayFill-11a46844","./VertexFormat-a4fe3a21","./BoxGeometry-3e7f6800","./CylinderGeometryLibrary-5646cdc3","./CylinderGeometry-dd2c7ed3","./EllipsoidGeometry-5c0fd559","./Color-1501ed7a"],(function(e,t,n,r,a,i,o,d,s,c,f,l,u,h,p,b,y,x,g,v,C,m,I){"use strict";function k(e){this.offset=e.offset,this.count=e.count,this.color=e.color,this.batchIds=e.batchIds}var M=new r.Cartesian3,B=o.Matrix4.packedLength+r.Cartesian3.packedLength,w=o.Matrix4.packedLength+2,A=o.Matrix4.packedLength+r.Cartesian3.packedLength,L=r.Cartesian3.packedLength+1,O={modelMatrix:new o.Matrix4,boundingVolume:new i.BoundingSphere};function E(e,t){var n=t*B,a=r.Cartesian3.unpack(e,n,M);n+=r.Cartesian3.packedLength;var i=o.Matrix4.unpack(e,n,O.modelMatrix);o.Matrix4.multiplyByScale(i,a,i);var d=O.boundingVolume;return r.Cartesian3.clone(r.Cartesian3.ZERO,d.center),d.radius=Math.sqrt(3),O}function U(e,t){var n=t*w,a=e[n++],i=e[n++],d=r.Cartesian3.fromElements(a,a,i,M),s=o.Matrix4.unpack(e,n,O.modelMatrix);o.Matrix4.multiplyByScale(s,d,s);var c=O.boundingVolume;return r.Cartesian3.clone(r.Cartesian3.ZERO,c.center),c.radius=Math.sqrt(2),O}function F(e,t){var n=t*A,a=r.Cartesian3.unpack(e,n,M);n+=r.Cartesian3.packedLength;var i=o.Matrix4.unpack(e,n,O.modelMatrix);o.Matrix4.multiplyByScale(i,a,i);var d=O.boundingVolume;return r.Cartesian3.clone(r.Cartesian3.ZERO,d.center),d.radius=1,O}function G(e,t){var n=t*L,a=e[n++],i=r.Cartesian3.unpack(e,n,M),d=o.Matrix4.fromTranslation(i,O.modelMatrix);o.Matrix4.multiplyByUniformScale(d,a,d);var s=O.boundingVolume;return r.Cartesian3.clone(r.Cartesian3.ZERO,s.center),s.radius=1,O}var S=new r.Cartesian3;function T(t,n,a,d,s){if(e.defined(n)){for(var c=a.length,f=d.attributes.position.values,l=d.indices,u=t.positions,h=t.vertexBatchIds,p=t.indices,b=t.batchIds,y=t.batchTableColors,x=t.batchedIndices,g=t.indexOffsets,v=t.indexCounts,C=t.boundingVolumes,m=t.modelMatrix,M=t.center,B=t.positionOffset,w=t.batchIdIndex,A=t.indexOffset,L=t.batchedIndicesOffset,O=0;O<c;++O){var E=s(n,O),U=E.modelMatrix;o.Matrix4.multiply(m,U,U);for(var F=a[O],G=f.length,T=0;T<G;T+=3){var V=r.Cartesian3.unpack(f,T,S);o.Matrix4.multiplyByPoint(U,V,V),r.Cartesian3.subtract(V,M,V),r.Cartesian3.pack(V,u,3*B+T),h[w++]=F}for(var R=l.length,D=0;D<R;++D)p[A+D]=l[D]+B;var P=O+L;x[P]=new k({offset:A,count:R,color:I.Color.fromRgba(y[F]),batchIds:[F]}),b[P]=F,g[P]=A,v[P]=R,C[P]=i.BoundingSphere.transform(E.boundingVolume,U),B+=G/3,A+=R}t.positionOffset=B,t.batchIdIndex=w,t.indexOffset=A,t.batchedIndicesOffset+=c}}var V=new r.Cartesian3,R=new o.Matrix4;function D(e,t,n){var r=n.length,a=2+r*i.BoundingSphere.packedLength+1+function(e){for(var t=e.length,n=0,r=0;r<t;++r)n+=I.Color.packedLength+3+e[r].batchIds.length;return n}(t),o=new Float64Array(a),d=0;o[d++]=e,o[d++]=r;for(var s=0;s<r;++s)i.BoundingSphere.pack(n[s],o,d),d+=i.BoundingSphere.packedLength;var c=t.length;o[d++]=c;for(var f=0;f<c;++f){var l=t[f];I.Color.pack(l.color,o,d),d+=I.Color.packedLength,o[d++]=l.offset,o[d++]=l.count;var u=l.batchIds,h=u.length;o[d++]=h;for(var p=0;p<h;++p)o[d++]=u[p]}return o}return b((function(t,n){var a=e.defined(t.boxes)?new Float32Array(t.boxes):void 0,i=e.defined(t.boxBatchIds)?new Uint16Array(t.boxBatchIds):void 0,d=e.defined(t.cylinders)?new Float32Array(t.cylinders):void 0,s=e.defined(t.cylinderBatchIds)?new Uint16Array(t.cylinderBatchIds):void 0,c=e.defined(t.ellipsoids)?new Float32Array(t.ellipsoids):void 0,f=e.defined(t.ellipsoidBatchIds)?new Uint16Array(t.ellipsoidBatchIds):void 0,l=e.defined(t.spheres)?new Float32Array(t.spheres):void 0,u=e.defined(t.sphereBatchIds)?new Uint16Array(t.sphereBatchIds):void 0,h=e.defined(a)?i.length:0,b=e.defined(d)?s.length:0,y=e.defined(c)?f.length:0,x=e.defined(l)?u.length:0,v=g.BoxGeometry.getUnitBox(),I=C.CylinderGeometry.getUnitCylinder(),k=m.EllipsoidGeometry.getUnitEllipsoid(),M=v.attributes.position.values,B=I.attributes.position.values,w=k.attributes.position.values,A=M.length*h;A+=B.length*b,A+=w.length*(y+x);var L=v.indices,O=I.indices,S=k.indices,P=L.length*h;P+=O.length*b,P+=S.length*(y+x);var Z=new Float32Array(A),q=new Uint16Array(A/3),W=p.IndexDatatype.createTypedArray(A/3,P),_=h+b+y+x,N=new Uint16Array(_),Y=new Array(_),j=new Uint32Array(_),z=new Uint32Array(_),H=new Array(_);!function(e){var t=new Float64Array(e),n=0;r.Cartesian3.unpack(t,n,V),n+=r.Cartesian3.packedLength,o.Matrix4.unpack(t,n,R)}(t.packedBuffer);var J={batchTableColors:new Uint32Array(t.batchTableColors),positions:Z,vertexBatchIds:q,indices:W,batchIds:N,batchedIndices:Y,indexOffsets:j,indexCounts:z,boundingVolumes:H,positionOffset:0,batchIdIndex:0,indexOffset:0,batchedIndicesOffset:0,modelMatrix:R,center:V};T(J,a,i,v,E),T(J,d,s,I,U),T(J,c,f,k,F),T(J,l,u,k,G);var K=D(W.BYTES_PER_ELEMENT,Y,H);return n.push(Z.buffer,q.buffer,W.buffer),n.push(N.buffer,j.buffer,z.buffer),n.push(K.buffer),{positions:Z.buffer,vertexBatchIds:q.buffer,indices:W.buffer,indexOffsets:j.buffer,indexCounts:z.buffer,batchIds:N.buffer,packedBuffer:K.buffer}}))}));
