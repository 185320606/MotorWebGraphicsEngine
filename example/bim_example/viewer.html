<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>BIM工程预览</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="zTreeStyle.css" type="text/css">
    <script src="jquery.min.js"></script>
    <script src="jquery.ztree.all.min.js"></script>
    <!-- <script src="https://lbdp.lubansoft.com/reference/motor-web-library/motor.js"></script> -->
    <!-- <script src="../../library/motor.js"></script> -->
    <script src="../common/common.js"></script>
</head>

<body>
    <div id="loading">
        <div class="loading-image" style="background-image:url('./img/ezgif.com-crop.gif');">
            <div style="text-align: center;vertical-align: middle;display: table-cell;color: white;height: 100px;padding-top: 80px;margin-top: 80px;">正在努力加载中...</div>
        </div>
    </div>
    <div id='container'></div>
    <div id='infoBox' style="display: none;"></div>
    <div class="tree_container" style="display: none;">
        <ul id="treeDemo" class="ztree"></ul>
    </div>
    <ul class='btns'>
        <li class='camera_reset' style='background: url("./static/images/ic_xiangji.png") no-repeat center' title="相机复位">
        </li>
        <li class="cim_bim" style='background: url("./static/images/ic_map.png") no-repeat center'
            title="地图显隐"></li>
        <li class="section" style='background: url("./static/images/ic_pouqie.png") no-repeat center;' title="剖切"></li>
        <li class="selectd" style='background: url("./static/images/ic_kuangxuanfangda.png") no-repeat center'
            title="框选放大"></li>
        <!-- let autoRoamManger = new Motor.AutoRoamManager(viewer);//传入Motor.Viewer对象 -->
        <li class="roam" style='background: url("./static/images/ic_manyou.png") no-repeat center' title="漫游"></li>
        <li class="map_serve" style='background: url("./static/images/ic_map_serve.png") no-repeat center'
            title="切换地图服务"></li>
        <li class="edge" style='background: url("./static/images/ic_hide.png") no-repeat center;background-size: 50px 36px;'
            title="边线开关"></li>
    </ul>
    <ul class="section_box">
        <li>X</li>
        <li>Y</li>
        <li>Z</li>
        <li>XYZ</li>
    </ul>
    <div class="roam_box">
        <ul>
            <!-- 开启录制, 每隔一秒添加一次相机姿态 -->
            <li><button class="Record">录制路径漫游动画</button>&nbsp;&nbsp;&nbsp;<span>正在录制中 ...</span></li>
            <!-- 关闭录制 -->
            <li><button class="closeRecord">关闭录制</button></li>
            <li><button class="router_file">导入路径文件</button></li>
            <!-- autoRoamManger.addPose() -->
            <li><button class="addPose">添加位置</button></li>
            <!-- autoRoamManger.playRoam(); -->
            <li><button class="playRoam">播放路径</button></li>
            <!-- autoRoamManger.stopRoam(); -->
            <li><button class="stopRoam">停止播放</button></li>
            <!-- autoRoamManger.emptyRoutes(); -->
            <li><button class="emptyRoutes">清空路径</button></li>
            <!-- console.log(JSON.stringify(autoRoamManger.cameraPoses)); -->
            <li><button class="consoleRoam">打印路径</button></li>
            <li>
                <div class="hr"></div>
            </li>
            <!-- viewer.navigationMode = Motor.NavigationMode.ROAM; -->
            <li><button class="first_person">开启全景漫游</button></li>
            <li><button class="first_person_close">关闭全景漫游</button></li>
            <!-- viewer.roamEditor.movementSpeed = 10; -->
            <li><b>移动速度</b>&nbsp;&nbsp;&nbsp;<input class="speed" type="range" min="1" max="20" value='1' step='1'></li>
            <!-- viewer.roamEditor.isGravitative = false; -->
            <li><input class="isGravitative " checked type="checkbox">&nbsp;&nbsp;&nbsp;<b>重力</b></li>
        </ul>
    </div>
    <ul class="map_serve_box">
        <li style="background:url('./static/images/ImageryProviders/bingAerial.png')" title="Bing"></li>
        <li style="background:url('./static/images/ImageryProviders/sentinel-2.png')" title="天地图"></li>
        <li style="background:url('./static/images/ImageryProviders/esriWorldImagery.png')" title="ArcGIS"></li>
        <li style="background:url('./static/images/ImageryProviders/WMTS.png')" title="WMTS"></li>
    </ul>
    <script>
        // $('#infoBox').hide();
        // $('.tree_container').hide();
        // $('.btns').hide();
        var isInSubScene = false,parentComponent;
        
        function decrypto(r,t,e){if("string"==typeof r&&"number"==typeof t&&"number"==typeof e){var n,o=[];e=e<=25?e:e%25;var a=String.fromCharCode(e+97);n=r.split(a);for(var f=0;f<n.length;f++){var i=parseInt(n[f],e);i=1*i^t;var p=String.fromCharCode(i);o.push(p)}return o.join("")}}
        
        var parameters = window.location.search.substring(1).split('&');
        var paramObj = {};
        var currentSelectedComponent,currentNameStr;
        parameters.forEach(function(ele){
            var keyvalue = ele.split("=");
            paramObj[keyvalue[0]] = keyvalue[1];
        })
        var paramsStr = decrypto(paramObj["params"], 123, 25);
        var params = paramsStr.split("&");
        paramObj = {};
        params.forEach(function(ele){
            var keyvalue = ele.split("=");
            paramObj[keyvalue[0]] = keyvalue[1];
        })

        var appid = paramObj["appid"];
        var secret = paramObj["secret"];
        var access_token = paramObj["access_token"];
        Motor.ServiceConfig.server = bimServer;

        var projectId = paramObj["projectId"];
        
        var selectedColor = Motor.Color.fromCssColorString('#03f3f7').withAlpha(0.5);
        // 动态加载数据
        function dynamicloadNodes(treeNode) {
            var projectIdParam = treeNode.getParentNode().getParentNode().getParentNode().projectId;
            var floor = treeNode.getParentNode().getParentNode().name;
            var mainType = treeNode.getParentNode().name;
            var subType = treeNode.name;
            return Motor.Component.PropertiesTreeDetail({
                projectId: projectIdParam,
                floor:floor,
                mainType:mainType,
                subType:subType
            })
        }

        // 重新设置数据
        function reSetNodes(zTreeObj) {
            node = zTreeObj.getNodes();      //获取根节点
            nodes = zTreeObj.transformToArray(node);    //遍历所有节点
            if (nodes.length > 0) {
                for (var i = 0; i < nodes.length; i++) {
                    if (!nodes[i].children) {         //判断需要显示复选框的条件
                        // console.log(nodes[i])
                        if(nodes[i].level === 3) {
                            nodes[i].isParent = true;
                        }
                        nodes[i].nocheck = true;				//nocheck为true表示没有选择框
                        zTreeObj.updateNode(nodes[i]);         //刷新
                    }
                }
            }
        }

        //初始化Viewer
        var viewer = new Motor.Viewer({
            container: 'container',//viewer所在的div元素id
            viewerMode: Motor.ViewerMode.BIM,//viewer的模式
            appid:appid,
            secret:secret,
            taaEnabled:true
            // access_token:access_token
        });
        viewer.readyPromise.then(function(){
            drawProject(projectId,true);
            //开启框选放大
            viewer.enableMarquee = true;
            //框选放大
            $('.selectd').on('click', function () {
                //开始一次框选放大
                viewer.marqueeEditor.startMarquee();
                $('body').css('cursor', 'crosshair');
                $('.selectd').css({ 'background': 'url("./static/images/ic_kuangxuanfangda_hover.png") no-repeat center', 'pointerEvents': 'none' })
            })
            //鼠标结束框选
            viewer.marqueeEditor.marqueeStop.addEventListener(function() {
                $('body').css('cursor', 'default');
                $('.selectd').css({ 'background': 'url("./static/images/ic_kuangxuanfangda.png") no-repeat center', 'pointerEvents': 'auto' })
            });

            //高亮构件并显示信息框
            function highlightComponent(component){
                //改变构件透明度
                component.setColor(selectedColor);
                //判断当前点选构件是否已经选中
                if (currentSelectedComponent && currentSelectedComponent.guid !== component.guid) {
                    //将之前选中的构件的颜色还原
                    currentSelectedComponent.setDefaultColor();
                }
                currentSelectedComponent = component;
                component.getBIMProperties().then(data=>{
                    var tableStr = '';
                    for(var group in data){
                        var temp = '';
                        data[group].forEach(item=>{
                            temp+=`
                                <div style="display: flex;width: 100%;justify-content: space-between; blackgroud-color:black;">
                                    <span style="color:#bdbcbc;width:200px;border:1px solid grey;padding: 2px 2px;">${item.name}</span>
                                    <span style="width:200px;border:1px solid grey;padding: 2px 2px;">${item.value?item.value:""} ${item.unit?item.unit:""}</span>
                                </div>
                            `;
                        })
                        tableStr+=`<div>
                            <div style="background-color:grey;">${group}</div>
                            ${temp}
                        </div>`;
                    }
                    $('#infoBox').html(tableStr);
                    $('#infoBox').show();
                });
            }       
            var currentSelectedComponent = undefined;
            //Motor.Color(0.1, 0.2, 0.4, 0.5);或者Motor.Color.fromBytes(255,255,255,125)

            //设置点选后的回调函数
            viewer.addMouseEventListener(Motor.MouseEventType.LEFT_CLICK,function(mouse){
                var obj = viewer.pick(mouse.position);
                if (obj instanceof Motor.ComponentView) {
                    var component = obj;
                    highlightComponent(component);
                }
                else{
                    viewer.currentScene.clearHighlightComponents();
                    $('#infoBox').hide();
                    if (currentSelectedComponent) {
                        //将之前选中的构件的颜色还原
                        currentSelectedComponent.setDefaultColor();
                        currentSelectedComponent = undefined;
                    }
                }
            });
            //双击飞向构件
            viewer.addMouseEventListener(Motor.MouseEventType.LEFT_DOUBLE_CLICK,function(mouse){
                var obj = viewer.pick(mouse.position);
                if (obj instanceof Motor.ComponentView) {
                    //飞向构件
                    viewer.zoomToComponent(obj,function(){
                        viewer.setLookAtCenter(mouse.position);//设置点击处为镜头旋转中心
                    });
                    
                }
            })
                
            

            


            //相机复位按钮
            $('.camera_reset').on('click', function () {
                viewer.gotoDefaultProjectView();
            })


            //CIM BIM切换
            $('.cim_bim').on('click', function () {
                //切换到CIM-BIM
                viewer.viewerMode = viewer.viewerMode == Motor.ViewerMode.CIM ? Motor.ViewerMode.BIM : Motor.ViewerMode.CIM;
                viewer.viewerMode == Motor.ViewerMode.BIM ? $('.cim_bim').css({ 'background': 'url("./static/images/ic_map.png") no-repeat center' }) : $('.cim_bim').css({ 'background': 'url("./static/images/ic_map_hover.png") no-repeat center' })
                if (viewer.viewerMode == Motor.ViewerMode.CIM) {
                    if (clippingPlaneEditor && !clippingPlaneEditor.isDestroyed()) {
                        $('.section_box').css('display', 'none');
                        clippingPlaneEditor.destroy();
                    }
                }
            })


            //剖切
            var clippingPlaneEditor;
            $('.section').on('click', function () {
                if (clippingPlaneEditor && !clippingPlaneEditor.isDestroyed()) {
                    $('.section').css('background', 'url("./static/images/ic_pouqie.png") no-repeat center')
                    $('.section_box').css('display', 'none');
                    clippingPlaneEditor.destroy();
                } else if (viewer.viewerMode != Motor.ViewerMode.CIM && viewer.navigationMode != Motor.NavigationMode.ROAM) {
                    $('.section').css('background', 'url("./static/images/ic_pouqie_hover.png") no-repeat center');
                    $('.section_box').css('display', 'block');
                    $('.section_box>li').css({ 'backgroundColor': 'rgb(2, 20, 48)' });
                    clippingPlaneEditor = new Motor.ClippingPlaneEditor({
                        viewer: viewer, //Motor.Viewer对象
                        scene: viewer.currentScene
                    });
                } else{
                    var str_1 = [];
                    if (viewer.viewerMode == Motor.ViewerMode.CIM) {
                        // str_1.push('请切换至BIM模式操作');
                        viewer.viewerMode = Motor.ViewerMode.BIM;
                    }
                    if (viewer.navigationMode == Motor.NavigationMode.ROAM) {
                        $('.roam_box').hide();
                        viewer.navigationMode = Motor.NavigationMode.DYNAMIC;
                        // str_1.push('请关闭全景漫游');
                    }
                    $('.section').css('background', 'url("./static/images/ic_pouqie_hover.png") no-repeat center');
                    $('.section_box').css('display', 'block');
                    $('.section_box>li').css({ 'backgroundColor': 'rgb(2, 20, 48)' });
                    clippingPlaneEditor = new Motor.ClippingPlaneEditor({
                        viewer: viewer, //Motor.Viewer对象
                        scene: viewer.currentScene
                    });
                    viewer.viewerMode == Motor.ViewerMode.BIM ? $('.cim_bim').css({ 'background': 'url("./static/images/ic_map.png") no-repeat center' }) : $('.cim_bim').css({ 'background': 'url("./static/images/ic_map_hover.png") no-repeat center' })
                    // alert(str_1.join(','));
                }
            });
            $('.section_box').on('click', 'li', function () {
                $(this).css({ 'backgroundColor': 'skyblue' }).siblings().css({ 'backgroundColor': 'rgb(2, 20, 48)' });
                $('.section_box').css('display', 'none');
                clippingPlaneEditor.addClippingPlane($(this).text());
            })


            //漫游
            var autoRoamManger
            $('.roam').on('click', function () {
                if(autoRoamManger && !autoRoamManger.isDestroyed()){
                    autoRoamManger.destroy();
                    $('.roam').css({ 'background': 'url("./static/images/ic_manyou.png") no-repeat center' });
                    $('.roam_box').hide();
                }
                else{
                    $('.roam').css({ 'background': 'url("./static/images/ic_manyou_hover.png") no-repeat center' });
                    $('.roam_box').show();
                    //初始化路径漫游管理器
                    autoRoamManger = new Motor.AutoRoamManager(viewer);//传入Motor.Viewer对象
                }
                
            });
            $('.router_file').on('click', function () {
                //从文件中加载路径关键点
                autoRoamManger.createRouteFromFile('./static/data/routes.json');
                //从数组对象中读取路径关键点
                // autoRoamManger.createRouteFromArray(array);
            })
            //开启录制, 每隔一秒添加一次相机姿态
            var timer;

            $('.Record').on('click', function () {
                $('.Record>span').css('display', 'inline');
                clearInterval(timer);
                timer = setInterval(function(){
                    autoRoamManger.addPose();
                }, 1000);
            })
            //关闭录制
            $('.closeRecord').on('click', function () {
                $('.Record>span').css('display', 'none');
                clearInterval(timer);
            })
            $('.addPose').on('click', function () {
                //将当前相机位置和姿态添加到路径中
                autoRoamManger.addPose();
            })
            $('.playRoam').on('click', function () {
                //播放路径
                autoRoamManger.playRoam();
            })
            $('.stopRoam').on('click', function () {
                //停止路径
                autoRoamManger.stopRoam();
            })
            $('.emptyRoutes').on('click', function () {
                //清空路径
                autoRoamManger.emptyRoutes();
            })
            $('.consoleRoam').on('click', function () {
                //获取路径点，输出的文本就可以直接保存成路径文件
                console.log(JSON.stringify(autoRoamManger.cameraPoses));
            })
            $('.first_person').on('click', function () {
                if (clippingPlaneEditor && !clippingPlaneEditor.isDestroyed()) {
                    $('.section').css('background', 'url("./static/images/ic_pouqie.png") no-repeat center')
                    clippingPlaneEditor.destroy();
                }
                //开启第一人称漫游
                viewer.navigationMode = Motor.NavigationMode.ROAM;
            })
            $('.first_person_close').on('click', function () {
                //关闭第一人称漫游
                viewer.navigationMode = Motor.NavigationMode.DYNAMIC;
            })
            $('.speed').on('change', function () {
                //修改漫游速度
                viewer.roamEditor.movementSpeed = $('.speed').val();
            })
            $('.isGravitative').on('change', function () {
                //开启/关闭重力
                viewer.roamEditor.isGravitative = viewer.roamEditor.isGravitative == true ? false : true;
            })

            //切换地图服务
            $('.map_serve').on('click', function () {
                if ($('.map_serve_box').css('display') == 'none') {
                    $('.map_serve').css({ 'background': 'url("./static/images/ic_map_serve_hover.png") no-repeat center' });
                    $('.map_serve_box').css({ 'display': 'block' })
                } else {
                    $('.map_serve').css({ 'background': 'url("./static/images/ic_map_serve.png") no-repeat center' });
                    $('.map_serve_box').css({ 'display': 'none' })
                }

            })
            $('.map_serve_box').on('click', 'li', function () {
                $('.map_serve').css({ 'background': 'url("./static/images/ic_map_serve.png") no-repeat center' });
                $('.map_serve_box').css('display', 'none');
                if ($(this).attr('title') == '天地图') {
                    //切换到天地图
                    viewer.setMap(new Motor.TiandituMap({
                        token: '2b6bbb88d28124168e36297ab20c6fa0',
                        maximumLevel: 17
                    }));
                } else if ($(this).attr('title') == 'ArcGIS') {
                    //切换到ArcGIS地图服务
                    viewer.setMap(new Motor.ArcGISMap({
                        url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'
                    }));
                } else if ($(this).attr('title') == 'WMTS') {
                    //切换到WMTS地图服务
                    viewer.setMap(new Motor.WebMapTileService({
                        url: 'http://cim.citylinker.com:13381/geoserver/gwc/service/wmts',
                        layer: 'bigdata:darkworld',
                        style: '',
                        tileMatrixSetID: 'EPSG:4326',
                        tileMatrixLabels: ['EPSG:4326:0', 'EPSG:4326:1', 'EPSG:4326:2', 'EPSG:4326:3', 'EPSG:4326:4', 'EPSG:4326:5', 'EPSG:4326:6', 'EPSG:4326:7', 'EPSG:4326:8', 'EPSG:4326:9', 'EPSG:4326:10',
                            'EPSG:4326:11', 'EPSG:4326:12', 'EPSG:4326:13', 'EPSG:4326:14', 'EPSG:4326:15'],
                        // minimum: 0,
                        maximumLevel: 15
                    }));
                } else if ($(this).attr('title') == 'Bing') {
                    viewer.setMap(new Motor.BingMap({
                        url: 'https://dev.virtualearth.net'
                    }));
                }
            });

            //边线显隐
            $('.edge').on('click', function () {
                viewer.currentScene.drawEdge = !viewer.currentScene.drawEdge;
            })
        })
        /**
         * 绘制工程
         */
        function drawProject(projectId,isInSubScene) {   
            viewer.loadSubProject({
                projectId: projectId,//工程id
                drawEdge: isInSubScene //绘制边线
            }).then(function () {
                $('#loading').hide();
                if(isInSubScene){
                    Motor.Component.PropertiesTreeStructur(projectId).then(function (data) {
                        var pTree = data;
                        pTree.forEach(function(p){
                            sortOnKey(p.children,"name");
                        });
                        // pTree[0].children.splice(1, 0, pTree[0].children[pTree[0].children.length-1]); 
                        // pTree[0].children.pop();
                        if(pTree){
                            var zTreeObj;
                            var setting = {
                                data: {
                                    key: {
                                        checked: "isChecked"
                                    }
                                },
                                view: {
                                    fontCss : {color:"white"}
                                },
                                check: {
                                    enable: true,       //设置是否显示checkbox复选框
                                },
                                callback: {
                                    // onClick: onClick,             //定义节点单击事件回调函数
                                    // onRightClick: OnRightClick,   //定义节点右键单击事件回调函数
                                    // beforeRename: beforeRename,   //定义节点重新编辑成功前回调函数，一般用于节点编辑时判断输入的节点名称是否合法
                                    // onDblClick: onDblClick,       //定义节点双击事件回调函数
                                    onCheck: function (e,id,treeNode) {
                                        console.log(treeNode);
                                        if(viewer.currentScene.drawEdge){
                                            viewer.currentScene.drawEdge=false;
                                        }
                                        
                                        viewer.currentScene.setVisiblityFromTree(treeNode);
                                        var treeObj = $.fn.zTree.getZTreeObj("treeDemo");  //获取树对象
                                        var nodes = treeObj.getCheckedNodes();       //获取勾选状态改变的节点
                                        // console.log(treeNode.getParentNode());
                                        var designIds = [];
                                        $.each(nodes, function (i, item) {

                                            designIds.push(item.id);                       //将状态改变的节点id输出到数组
                                            item.checkedOld = item.checked;                //这句话很关键，将节点的初始状态置为当前状态。否则每次勾选操作获取状态改变节点时只会跟树初始化的状态相比较。
                                        })
                                    },//定义节点复选框选中或取消选中事件的回调函数
                                    onClick: function (e,id,treeNode){
                                        let tmp = treeNode;
                                        const strArr = [];
                                        let str = '@@'
                                        for(let i = treeNode.level;i>0;i--){
                                            strArr.push(tmp.name)
                                            tmp = tmp.getParentNode();
                                        }
                                        str += strArr.reverse().join('@@') + '@@';
                                        const projectId = tmp.projectId;
                                        const nameStr = treeNode.level === 0 ? '' : str;
                                        const guid = treeNode.level === 4 ? treeNode.id : '';
                                        $('#infoBox').hide();
                                        if(currentNameStr===nameStr){
                                            viewer.currentScene.clearHighlightComponentsFromTree();
                                            currentNameStr = undefined;
                                        }
                                        else{
                                            viewer.currentScene.setHighlightComponentsFromTree(projectId, nameStr, guid, selectedColor,Motor.Color.WHITE.withAlpha(0.5));
                                            currentNameStr = nameStr;
                                        }
                                        
                                    },
                                    onDblClick:function(e,id,treeNode){
                                        if(!treeNode.children && treeNode.level === 4){
                                            var component = viewer.currentScene.getComponentFromTree(treeNode.projectId, treeNode);
                                            var innerHTML = '';
                                            for (var key in component.infos) {
                                                innerHTML += '<div title='+component.infos[key]+'>'+key+': '+component.infos[key]+'</div>';
                                            }
                                            $('#infoBox').html('<div title='+component.guid+'>'+component.guid+'</div>' + innerHTML);
                                            $('#infoBox').show();
                                            viewer.zoomToComponent(component,function(){
                                                viewer.setLookAtCenter();//设置点击处为镜头旋转中心
                                            });
                                        }
                                        else{
                                            $('#infoBox').hide();
                                        }
                                    },
                                    onExpand: function(event, treeId, treeNode) {
                                        if(treeNode.level ===3 && !treeNode.children) {
                                            dynamicloadNodes(treeNode).then(function(data) {
                                                treeNode.children = [];
                                                zTreeObj.addNodes(treeNode, data)
                                                reSetNodes(zTreeObj)
                                            })
                                        }
                                    }
                                },
                            };        // zTree 的参数配置
                            var zNodes = pTree;        // zTree 的数据属性，此处使用标准json格式

                            zTreeObj = $.fn.zTree.init($("#treeDemo"), setting, zNodes); //初始化zTree，三个参数一次分别是容器(zTree 的容器 className 别忘了设置为 "ztree")、参数配置、数据源
                            zTreeObj.checkAllNodes(true);
                            reSetNodes(zTreeObj);
                            $('.tree_container').show();
                        }
                    });
                    
                }                    
            });
            
        }

        function sortOnKey(arr,key){
            arr.sort(function(a,b){
                var left = parseFloat(a[key]);
                var right = parseFloat(b[key]);
                if(left<right){return -1;}
                else if(left>right){return 1;}
                else return 0;
            });
        }
    </script>
</body>

</html>